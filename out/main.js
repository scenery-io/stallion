var ne=Object.create;var h=Object.defineProperty;var ie=Object.getOwnPropertyDescriptor;var oe=Object.getOwnPropertyNames;var se=Object.getPrototypeOf,ae=Object.prototype.hasOwnProperty;var ce=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),pe=(e,t)=>{for(var r in t)h(e,r,{get:t[r],enumerable:!0})},I=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of oe(t))!ae.call(e,i)&&i!==r&&h(e,i,{get:()=>t[i],enumerable:!(n=ie(t,i))||n.enumerable});return e};var d=(e,t,r)=>(r=e!=null?ne(se(e)):{},I(t||!e||!e.__esModule?h(r,"default",{value:e,enumerable:!0}):r,e)),le=e=>I(h({},"__esModule",{value:!0}),e);var j=ce((Ne,O)=>{"use strict";var be=require("fs"),ve=require("os"),T=Symbol.for("__RESOLVED_TEMP_DIRECTORY__");global[T]||Object.defineProperty(global,T,{value:be.realpathSync(ve.tmpdir())});O.exports=global[T]});var Re={};pe(Re,{activate:()=>Me,deactivate:()=>ke});module.exports=le(Re);var v=require("vscode");var g=require("vscode");var P=d(require("node:fs"),1),V=d(require("node:fs/promises"),1),C=d(require("node:path"),1),J=d(require("node:stream"),1),U=require("node:util");var L=require("util"),w=d(require("crypto"),1),F=(0,L.promisify)(w.default.randomBytes),ue="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-._~".split(""),me="0123456789".split(""),de="CDEHKMPRTUWXY012458".split(""),fe="!\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~".split(""),ye="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".split(""),ge=(e,t)=>{let r=t.length,n=Math.floor(65536/r)*r-1,i=2*Math.ceil(1.1*e),s="",a=0;for(;a<e;){let p=w.default.randomBytes(i),c=0;for(;c<i&&a<e;){let f=p.readUInt16LE(c);c+=2,!(f>n)&&(s+=t[f%r],a++)}}return s},he=async(e,t)=>{let r=t.length,n=Math.floor(65536/r)*r-1,i=2*Math.ceil(1.1*e),s="",a=0;for(;a<e;){let p=await F(i),c=0;for(;c<i&&a<e;){let f=p.readUInt16LE(c);c+=2,!(f>n)&&(s+=t[f%r],a++)}}return s},we=(e,t,r)=>w.default.randomBytes(e).toString(t).slice(0,r),Se=async(e,t,r)=>(await F(e)).toString(t).slice(0,r),xe=new Set([void 0,"hex","base64","url-safe","numeric","distinguishable","ascii-printable","alphanumeric"]),N=(e,t)=>({length:r,type:n,characters:i})=>{if(!(r>=0&&Number.isFinite(r)))throw new TypeError("Expected a `length` to be a non-negative finite number");if(n!==void 0&&i!==void 0)throw new TypeError("Expected either `type` or `characters`");if(i!==void 0&&typeof i!="string")throw new TypeError("Expected `characters` to be string");if(!xe.has(n))throw new TypeError(`Unknown type: ${n}`);if(n===void 0&&i===void 0&&(n="hex"),n==="hex"||n===void 0&&i===void 0)return t(Math.ceil(r*.5),"hex",r);if(n==="base64")return t(Math.ceil(r*.75),"base64",r);if(n==="url-safe")return e(r,ue);if(n==="numeric")return e(r,me);if(n==="distinguishable")return e(r,de);if(n==="ascii-printable")return e(r,fe);if(n==="alphanumeric")return e(r,ye);if(i.length===0)throw new TypeError("Expected `characters` string length to be greater than or equal to 1");if(i.length>65536)throw new TypeError("Expected `characters` string length to be less or equal to 65536");return e(r,i.split(""))},W=N(ge,we);W.async=N(he,Se);var _=W;function E(){return _({length:32})}var q=d(j(),1);function A(e){return e!==null&&typeof e=="object"&&typeof e.pipe=="function"}var Ce=d(j(),1),Ee=(0,U.promisify)(J.default.pipeline),B=(e="")=>C.default.join(q.default,e+E()),Te=async(e,t)=>Ee(t,P.default.createWriteStream(e));function je({name:e,extension:t}={}){if(e){if(t!=null)throw new Error("The `name` and `extension` options are mutually exclusive");return C.default.join(Pe(),e)}return B()+(t==null?"":"."+t.replace(/^\./,""))}function Pe({prefix:e=""}={}){let t=B(e);return P.default.mkdirSync(t),t}async function $(e,t){let r=je(t);return await(A(e)?Te:V.default.writeFile)(r,e),r}var m=require("vscode"),M=require("module"),Q=require("fs");async function S(e){try{let t=m.workspace.getConfiguration("stallion").get("address","127.0.0.1"),r=m.workspace.getConfiguration("stallion").get("port",8080),n=`http://${t}:${r}/post`;if(!(await fetch(n,{method:"POST",body:JSON.stringify(e)})).ok)throw new Error("Failed to send to Cavalry");m.window.showInformationMessage("Successfully sent to Cavalry")}catch(t){if(t.cause?.code==="ECONNREFUSED")return m.window.showErrorMessage("Failed to send. Is Stallion open in Cavalry?");throw t}}function k(e){return M.stripTypeScriptTypes?(0,M.stripTypeScriptTypes)(e):(m.window.showWarningMessage("Type stripping is not supported. Expect errors in Cavalry."),e)}async function K(e){let t=e.getText(),r=e.languageId==="typescript"?k(t):t,n=`(function() { ${r} 
})()`,i=!e.isUntitled,s=r.includes("ui.show()");return r.includes("ui.add(")&&!s&&m.window.showWarningMessage("Script is missing `ui.show()`"),i&&s?e.fileName:await $(n,{extension:"js"})}function Y(e,t={}){return new Promise((r,n)=>{let i=(0,Q.createReadStream)(e,t.encoding||"utf-8"),s="",a=0,p;i.on("data",c=>{p=c.indexOf(t.lineEnding||`
`),s+=c,p===-1?a+=c.length:(a+=p,i.close())}).on("close",()=>r(s.slice(s.charCodeAt(0)===65279?1:0,a))).on("error",c=>n(c))})}var G=async()=>{try{let e=g.window.activeTextEditor?.document;if(!e)return g.window.showErrorMessage("No active document");e.languageId!=="javascript"&&e.languageId!=="typescript"&&g.window.showWarningMessage("Language is not JavaScript or TypeScript");let t=await K(e);await S({type:"script",path:t})}catch(e){console.error(e),g.window.showErrorMessage(e.message)}};var u=require("vscode");var H="cavalry-bridge";var X="0.6.0";var z="Scenery";var Z=async()=>{try{let e=u.window.activeTextEditor,t=e?.document;if(!t)return u.window.showWarningMessage("No active document");t.languageId!=="javascript"&&(u.languages.setTextDocumentLanguage(t,"javascript"),u.window.showInformationMessage("Language set to JavaScript"));let r=[z,H].join("."),n=u.extensions.getExtension(r);if(!n)throw new Error(`Extension not found: ${r}`);let p=`/// <reference path="${[n.extensionPath.replaceAll("\\","/"),"node_modules","@scenery/cavalry-types","index.d.ts"].join("/")}"/>

`;await e.edit(c=>c.insert(new u.Position(0,0),p))}catch(e){console.log(e),u.window.showErrorMessage(e.message)}};var l=require("path"),o=require("vscode");var ee=async e=>{try{let t=o.window.activeTextEditor?.document;if(!t)return o.window.showErrorMessage("No active document");let r=(0,l.join)(e.extensionPath,"images"),n=await o.window.showQuickPick([{label:"Layers",kind:o.QuickPickItemKind.Separator},{label:"JavaScript Shape",type:"javaScriptShape",iconPath:o.Uri.file((0,l.join)(r,"javaScriptShape@2x.png"))},{label:"JavaScript Utility",type:"javaScript",iconPath:o.Uri.file((0,l.join)(r,"javaScript@2x.png"))},{label:"JavaScript Modifier",type:"javaScriptModifier",iconPath:o.Uri.file((0,l.join)(r,"javaScriptModifier@2x.png"))},{label:"JavaScript Deformer",type:"javaScriptDeformer",iconPath:o.Uri.file((0,l.join)(r,"javaScriptDeformer@2x.png"))},{label:"JavaScript Emitter",type:"javaScriptEmitter",iconPath:o.Uri.file((0,l.join)(r,"javaScriptEmitter@2x.png"))},{label:"SkSL Shader",type:"skslShader",iconPath:o.Uri.file((0,l.join)(r,"skslShader@2x.png"))},{label:"SkSL Filter",type:"skslFilter",iconPath:o.Uri.file((0,l.join)(r,"skslFilter@2x.png"))},{label:"Renders",kind:o.QuickPickItemKind.Separator},{label:"Setup Script",type:"renderSetupExpression",iconPath:o.Uri.file((0,l.join)(r,"dynamicRendering@2x.png"))},{label:"Pre-Render Script",type:"preRenderExpression",iconPath:o.Uri.file((0,l.join)(r,"dynamicRendering@2x.png"))},{label:"Post-Render Script",type:"postRenderExpression",iconPath:o.Uri.file((0,l.join)(r,"dynamicRendering@2x.png"))}]);if(!n)return;let i=n.type.toLowerCase();t.languageId!=="javascript"&&t.languageId!=="typescript"&&(i.startsWith("javascript")||i.includes("render"))&&o.window.showWarningMessage("Language is not JavaScript or TypeScript");let s=/\/\/\/\s<reference.+\/>(\r?\n|$)/g,a=t.getText().replace(s,"").trim(),p=t.languageId==="typescript"?k(a):a;await S({type:n.type,code:p})}catch(t){console.error(t),o.window.showErrorMessage(t.message)}};var D=require("fs"),x=require("fs/promises"),b=require("os"),y=require("path"),te=require("vscode");var re=async()=>{try{let e="Stallion.js",t=(0,y.join)(__dirname,e);console.log({source:t});let r=(0,b.platform)()==="darwin",n=(0,b.homedir)(),i=r?(0,y.join)(n,"Library","Application Support"):(0,y.join)(n,"AppData","Roaming"),s=(0,y.join)(i,"Cavalry","Scripts"),a=(0,y.join)(s,e);if((0,D.existsSync)(s)||await(0,x.mkdir)(s),(0,D.existsSync)(a)){let p=await Y(a),c=X;if(p.match(/VERSION \d+.\d+.\d+/)?.[0].replace("VERSION ","")===c)return}await(0,x.copyFile)(t,a)}catch(e){te.window.showErrorMessage(e.message)}};async function Me(e){console.log("Stallion activated"),await re();let t=v.commands.registerCommand("stallion.post",G),r=v.commands.registerCommand("stallion.postas",()=>ee(e)),n=v.commands.registerCommand("stallion.insert",Z);e.subscriptions.push(t,n,r)}function ke(){}0&&(module.exports={activate,deactivate});
