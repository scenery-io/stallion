var w=Object.defineProperty;var W=Object.getOwnPropertyDescriptor;var $=Object.getOwnPropertyNames;var U=Object.prototype.hasOwnProperty;var A=(e,t)=>{for(var r in t)w(e,r,{get:t[r],enumerable:!0})},_=(e,t,r,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of $(t))!U.call(e,n)&&n!==r&&w(e,n,{get:()=>t[n],enumerable:!(o=W(t,n))||o.enumerable});return e};var Q=e=>_(w({},"__esModule",{value:!0}),e);var z={};A(z,{activate:()=>K,deactivate:()=>q});module.exports=Q(z);var S=require("vscode");var f=require("vscode");var m=require("vscode"),x=require("module"),j=require("fs"),u=require("fs/promises"),C=require("os"),T=require("path"),M=require("crypto");async function y(e){try{let t=m.workspace.getConfiguration("stallion").get("address","127.0.0.1"),r=m.workspace.getConfiguration("stallion").get("port",8080),o=`http://${t}:${r}/post`;if(!(await fetch(o,{method:"POST",body:JSON.stringify(e)})).ok)throw new Error("Failed to send to Cavalry");m.window.showInformationMessage("Successfully sent to Cavalry")}catch(t){if(t.cause?.code==="ECONNREFUSED")return m.window.showErrorMessage("Failed to send. Is Stallion open in Cavalry?");throw t}}function E(e){return x.stripTypeScriptTypes?(0,x.stripTypeScriptTypes)(e):(m.window.showWarningMessage("Type stripping is not supported. Expect errors in Cavalry."),e)}async function B(e){let t=await(0,u.realpath)((0,C.tmpdir)()),r=(0,T.join)(t,`${(0,M.randomUUID)()}.js`);return await(0,u.writeFile)(r,e),r}async function k(e){let t=e.getText(),r=e.languageId==="typescript"?E(t):t,o=`(function() { ${r} 
})()`,n=!e.isUntitled,s=r.includes("ui.show()");return r.includes("ui.add(")&&!s&&m.window.showWarningMessage("Script is missing `ui.show()`"),n&&s?e.fileName:await B(o)}function I(e,t={}){return new Promise((r,o)=>{let n=(0,j.createReadStream)(e,t.encoding||"utf-8"),s="",c=0,l;n.on("data",d=>{l=d.indexOf(t.lineEnding||`
`),s+=d,l===-1?c+=d.length:(c+=l,n.close())}).on("close",()=>r(s.slice(s.charCodeAt(0)===65279?1:0,c))).on("error",d=>o(d))})}var N=async()=>{try{let e=f.window.activeTextEditor?.document;if(!e)return f.window.showErrorMessage("No active document");e.languageId!=="javascript"&&e.languageId!=="typescript"&&f.window.showWarningMessage("Language is not JavaScript or TypeScript");let t=await k(e);await y({type:"script",path:t})}catch(e){console.error(e),f.window.showErrorMessage(e.message)}};var a=require("path"),i=require("vscode");var D=async e=>{try{let t=i.window.activeTextEditor?.document;if(!t)return i.window.showErrorMessage("No active document");let r=(0,a.join)(e.extensionPath,"images"),o=await i.window.showQuickPick([{label:"Layers",kind:i.QuickPickItemKind.Separator},{label:"JavaScript Shape",type:"javaScriptShape",iconPath:i.Uri.file((0,a.join)(r,"javaScriptShape@2x.png"))},{label:"JavaScript Utility",type:"javaScript",iconPath:i.Uri.file((0,a.join)(r,"javaScript@2x.png"))},{label:"JavaScript Modifier",type:"javaScriptModifier",iconPath:i.Uri.file((0,a.join)(r,"javaScriptModifier@2x.png"))},{label:"JavaScript Deformer",type:"javaScriptDeformer",iconPath:i.Uri.file((0,a.join)(r,"javaScriptDeformer@2x.png"))},{label:"JavaScript Emitter",type:"javaScriptEmitter",iconPath:i.Uri.file((0,a.join)(r,"javaScriptEmitter@2x.png"))},{label:"SkSL Shader",type:"skslShader",iconPath:i.Uri.file((0,a.join)(r,"skslShader@2x.png"))},{label:"SkSL Filter",type:"skslFilter",iconPath:i.Uri.file((0,a.join)(r,"skslFilter@2x.png"))},{label:"Renders",kind:i.QuickPickItemKind.Separator},{label:"Setup Script",type:"renderSetupExpression",iconPath:i.Uri.file((0,a.join)(r,"dynamicRendering@2x.png"))},{label:"Pre-Render Script",type:"preRenderExpression",iconPath:i.Uri.file((0,a.join)(r,"dynamicRendering@2x.png"))},{label:"Post-Render Script",type:"postRenderExpression",iconPath:i.Uri.file((0,a.join)(r,"dynamicRendering@2x.png"))}]);if(!o)return;let n=o.type.toLowerCase();t.languageId!=="javascript"&&t.languageId!=="typescript"&&(n.startsWith("javascript")||n.includes("render"))&&i.window.showWarningMessage("Language is not JavaScript or TypeScript");let s=/\/\/\/\s<reference.+\/>(\r?\n|$)/g,c=t.getText().replace(s,"").trim(),l=t.languageId==="typescript"?E(c):c;await y({type:o.type,code:l})}catch(t){console.error(t),i.window.showErrorMessage(t.message)}};var p=require("vscode");var R="cavalry-bridge";var O="0.6.3",F="Scenery";var J=async()=>{try{let e=p.window.activeTextEditor,t=e?.document;if(!t)return p.window.showWarningMessage("No active document");t.languageId!=="javascript"&&t.languageId!=="typescript"&&(p.languages.setTextDocumentLanguage(t,"javascript"),p.window.showInformationMessage("Language set to JavaScript"));let r=[F,R].join("."),o=p.extensions.getExtension(r);if(!o)throw new Error(`Extension not found: ${r}`);let l=`/// <reference path="${[o.extensionPath.replaceAll("\\","/"),"node_modules","@scenery/cavalry-types","index.d.ts"].join("/")}"/>

`;await e.edit(d=>d.insert(new p.Position(0,0),l))}catch(e){console.log(e),p.window.showErrorMessage(e.message)}};var P=require("fs"),h=require("fs/promises"),v=require("os"),g=require("path"),L=require("vscode");var V=async()=>{try{let e="Stallion.js",t=(0,g.join)(__dirname,e);console.log({source:t});let r=(0,v.platform)()==="darwin",o=(0,v.homedir)(),n=r?(0,g.join)(o,"Library","Application Support"):(0,g.join)(o,"AppData","Roaming"),s=(0,g.join)(n,"Cavalry","Scripts"),c=(0,g.join)(s,e);if((0,P.existsSync)(s)||await(0,h.mkdir)(s),(0,P.existsSync)(c)){let l=await I(c),d=O;if(l.match(/VERSION \d+.\d+.\d+/)?.[0].replace("VERSION ","")===d)return}await(0,h.copyFile)(t,c)}catch(e){L.window.showErrorMessage(e.message)}};async function K(e){console.log("Stallion activated"),await V(),e.subscriptions.push(S.commands.registerCommand("stallion.post",N),S.commands.registerCommand("stallion.postas",()=>D(e)),S.commands.registerCommand("stallion.insert",J))}function q(){}0&&(module.exports={activate,deactivate});
