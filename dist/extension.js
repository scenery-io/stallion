var x=Object.defineProperty;var $=Object.getOwnPropertyDescriptor;var U=Object.getOwnPropertyNames;var W=Object.prototype.hasOwnProperty;var A=(t,e)=>{for(var r in e)x(t,r,{get:e[r],enumerable:!0})},_=(t,e,r,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of U(e))!W.call(t,n)&&n!==r&&x(t,n,{get:()=>e[n],enumerable:!(o=$(e,n))||o.enumerable});return t};var Q=t=>_(x({},"__esModule",{value:!0}),t);var z={};A(z,{activate:()=>K,deactivate:()=>q});module.exports=Q(z);var S=require("vscode");var f=require("vscode");var m=require("vscode"),w=require("module"),P=require("fs"),u=require("fs/promises"),C=require("os"),T=require("path"),M=require("crypto");async function y(t){try{let e=m.workspace.getConfiguration("stallion").get("address","127.0.0.1"),r=m.workspace.getConfiguration("stallion").get("port",8080),o=`http://${e}:${r}/post`;if(!(await fetch(o,{method:"POST",body:JSON.stringify(t)})).ok)throw new Error("Failed to send to Cavalry");m.window.showInformationMessage("Successfully sent to Cavalry")}catch(e){if(e.cause?.code==="ECONNREFUSED")return m.window.showErrorMessage("Failed to send. Is Stallion open in Cavalry?");throw e}}function E(t){return w.stripTypeScriptTypes?(0,w.stripTypeScriptTypes)(t):(m.window.showWarningMessage("Type stripping is not supported. Expect errors in Cavalry."),t)}async function B(t){let e=await(0,u.realpath)((0,C.tmpdir)()),r=(0,T.join)(e,`${(0,M.randomUUID)()}.js`);return await(0,u.writeFile)(r,t),r}async function I(t){let e=t.getText(),r=t.languageId==="typescript"?E(e):e,o=`(function() { ${r} 
})()`,n=!t.isUntitled,s=r.includes("ui.show()");return r.includes("ui.add(")&&!s&&m.window.showWarningMessage("Script is missing `ui.show()`"),n&&s?t.fileName:await B(o)}function N(t,e={}){return new Promise((r,o)=>{let n=(0,P.createReadStream)(t,e.encoding||"utf-8"),s="",c=0,l;n.on("data",d=>{l=d.indexOf(e.lineEnding||`
`),s+=d,l===-1?c+=d.length:(c+=l,n.close())}).on("close",()=>r(s.slice(s.charCodeAt(0)===65279?1:0,c))).on("error",d=>o(d))})}var k=async()=>{try{let t=f.window.activeTextEditor?.document;if(!t)return f.window.showErrorMessage("No active document");t.languageId!=="javascript"&&t.languageId!=="typescript"&&f.window.showWarningMessage("Language is not JavaScript or TypeScript");let e=await I(t);await y({type:"script",path:e})}catch(t){console.error(t),f.window.showErrorMessage(t.message)}};var a=require("path"),i=require("vscode");var D=async t=>{try{let e=i.window.activeTextEditor?.document;if(!e)return i.window.showErrorMessage("No active document");let r=(0,a.join)(t.extensionPath,"images"),o=await i.window.showQuickPick([{label:"Layers",kind:i.QuickPickItemKind.Separator},{label:"JavaScript Shape",type:"javaScriptShape",iconPath:i.Uri.file((0,a.join)(r,"javaScriptShape@2x.png"))},{label:"JavaScript Utility",type:"javaScript",iconPath:i.Uri.file((0,a.join)(r,"javaScript@2x.png"))},{label:"JavaScript Modifier",type:"javaScriptModifier",iconPath:i.Uri.file((0,a.join)(r,"javaScriptModifier@2x.png"))},{label:"JavaScript Deformer",type:"javaScriptDeformer",iconPath:i.Uri.file((0,a.join)(r,"javaScriptDeformer@2x.png"))},{label:"JavaScript Emitter",type:"javaScriptEmitter",iconPath:i.Uri.file((0,a.join)(r,"javaScriptEmitter@2x.png"))},{label:"SkSL Shader",type:"skslShader",iconPath:i.Uri.file((0,a.join)(r,"skslShader@2x.png"))},{label:"SkSL Filter",type:"skslFilter",iconPath:i.Uri.file((0,a.join)(r,"skslFilter@2x.png"))},{label:"Renders",kind:i.QuickPickItemKind.Separator},{label:"Setup Script",type:"renderSetupExpression",iconPath:i.Uri.file((0,a.join)(r,"dynamicRendering@2x.png"))},{label:"Pre-Render Script",type:"preRenderExpression",iconPath:i.Uri.file((0,a.join)(r,"dynamicRendering@2x.png"))},{label:"Post-Render Script",type:"postRenderExpression",iconPath:i.Uri.file((0,a.join)(r,"dynamicRendering@2x.png"))}]);if(!o)return;let n=o.type.toLowerCase();e.languageId!=="javascript"&&e.languageId!=="typescript"&&(n.startsWith("javascript")||n.includes("render"))&&i.window.showWarningMessage("Language is not JavaScript or TypeScript");let s=/\/\/\/\s<reference.+\/>(\r?\n|$)/g,c=e.getText().replace(s,"").trim(),l=e.languageId==="typescript"?E(c):c;await y({type:o.type,code:l})}catch(e){console.error(e),i.window.showErrorMessage(e.message)}};var p=require("vscode");var R="cavalry-bridge";var O="0.6.1",F="Scenery";var J=async()=>{try{let t=p.window.activeTextEditor,e=t?.document;if(!e)return p.window.showWarningMessage("No active document");e.languageId!=="javascript"&&e.languageId!=="typescript"&&(p.languages.setTextDocumentLanguage(e,"javascript"),p.window.showInformationMessage("Language set to JavaScript"));let r=[F,R].join("."),o=p.extensions.getExtension(r);if(!o)throw new Error(`Extension not found: ${r}`);let l=`/// <reference path="${[o.extensionPath.replaceAll("\\","/"),"node_modules","@scenery/cavalry-types","index.d.ts"].join("/")}"/>

`;await t.edit(d=>d.insert(new p.Position(0,0),l))}catch(t){console.log(t),p.window.showErrorMessage(t.message)}};var j=require("fs"),h=require("fs/promises"),v=require("os"),g=require("path"),L=require("vscode");var V=async()=>{try{let t="Stallion.js",e=(0,g.join)(__dirname,t);console.log({source:e});let r=(0,v.platform)()==="darwin",o=(0,v.homedir)(),n=r?(0,g.join)(o,"Library","Application Support"):(0,g.join)(o,"AppData","Roaming"),s=(0,g.join)(n,"Cavalry","Scripts"),c=(0,g.join)(s,t);if((0,j.existsSync)(s)||await(0,h.mkdir)(s),(0,j.existsSync)(c)){let l=await N(c),d=O;if(l.match(/VERSION \d+.\d+.\d+/)?.[0].replace("VERSION ","")===d)return}await(0,h.copyFile)(e,c)}catch(t){L.window.showErrorMessage(t.message)}};async function K(t){console.log("Stallion activated"),await V(),t.subscriptions.push(S.commands.registerCommand("stallion.post",k),S.commands.registerCommand("stallion.postas",()=>D(t)),S.commands.registerCommand("stallion.insert",J))}function q(){}0&&(module.exports={activate,deactivate});
