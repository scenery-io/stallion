var w=Object.defineProperty;var W=Object.getOwnPropertyDescriptor;var $=Object.getOwnPropertyNames;var A=Object.prototype.hasOwnProperty;var U=(t,e)=>{for(var r in e)w(t,r,{get:e[r],enumerable:!0})},_=(t,e,r,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of $(e))!A.call(t,n)&&n!==r&&w(t,n,{get:()=>e[n],enumerable:!(i=W(e,n))||i.enumerable});return t};var Q=t=>_(w({},"__esModule",{value:!0}),t);var z={};U(z,{activate:()=>K,deactivate:()=>q});module.exports=Q(z);var S=require("vscode");var f=require("vscode");var m=require("vscode"),x=require("module"),C=require("fs"),u=require("fs/promises"),P=require("os"),T=require("path"),M=require("crypto");async function y(t){try{let e=m.workspace.getConfiguration("stallion").get("address","127.0.0.1"),r=m.workspace.getConfiguration("stallion").get("port",8080),i=`http://${e}:${r}/post`;if(!(await fetch(i,{method:"POST",body:JSON.stringify(t)})).ok)throw new Error("Failed to send to Cavalry");m.window.showInformationMessage("Successfully sent to Cavalry")}catch(e){if(e.cause?.code==="ECONNREFUSED")return m.window.showErrorMessage("Failed to send. Is Stallion open in Cavalry?");throw e}}function E(t){return x.stripTypeScriptTypes?(0,x.stripTypeScriptTypes)(t):(m.window.showWarningMessage("Type stripping is not supported. Expect errors in Cavalry."),t)}async function B(t){let e=await(0,u.realpath)((0,P.tmpdir)()),r=(0,T.join)(e,`${(0,M.randomUUID)()}.js`);return await(0,u.writeFile)(r,t),r}async function k(t){let e=t.getText(),r=t.languageId==="typescript"?E(e):e,i=`(function() { ${r} 
})()`,n=!t.isUntitled,s=r.includes("ui.show()");return r.includes("ui.add(")&&!s&&m.window.showWarningMessage("Script is missing `ui.show()`"),n&&s?t.fileName:await B(i)}function I(t,e={}){return new Promise((r,i)=>{let n=(0,C.createReadStream)(t,e.encoding||"utf-8"),s="",c=0,l;n.on("data",d=>{l=d.indexOf(e.lineEnding||`
`),s+=d,l===-1?c+=d.length:(c+=l,n.close())}).on("close",()=>r(s.slice(s.charCodeAt(0)===65279?1:0,c))).on("error",d=>i(d))})}var N=async()=>{try{let t=f.window.activeTextEditor?.document;if(!t)return f.window.showErrorMessage("No active document");t.languageId!=="javascript"&&t.languageId!=="typescript"&&f.window.showWarningMessage("Language is not JavaScript or TypeScript");let e=await k(t);await y({type:"script",path:e})}catch(t){console.error(t),f.window.showErrorMessage(t.message)}};var p=require("vscode");var D="cavalry-bridge";var R="0.6.0",O="Scenery";var F=async()=>{try{let t=p.window.activeTextEditor,e=t?.document;if(!e)return p.window.showWarningMessage("No active document");e.languageId!=="javascript"&&e.languageId!=="typescript"&&(p.languages.setTextDocumentLanguage(e,"javascript"),p.window.showInformationMessage("Language set to JavaScript"));let r=[O,D].join("."),i=p.extensions.getExtension(r);if(!i)throw new Error(`Extension not found: ${r}`);let l=`/// <reference path="${[i.extensionPath.replaceAll("\\","/"),"node_modules","@scenery/cavalry-types","index.d.ts"].join("/")}"/>

`;await t.edit(d=>d.insert(new p.Position(0,0),l))}catch(t){console.log(t),p.window.showErrorMessage(t.message)}};var a=require("path"),o=require("vscode");var J=async t=>{try{let e=o.window.activeTextEditor?.document;if(!e)return o.window.showErrorMessage("No active document");let r=(0,a.join)(t.extensionPath,"images"),i=await o.window.showQuickPick([{label:"Layers",kind:o.QuickPickItemKind.Separator},{label:"JavaScript Shape",type:"javaScriptShape",iconPath:o.Uri.file((0,a.join)(r,"javaScriptShape@2x.png"))},{label:"JavaScript Utility",type:"javaScript",iconPath:o.Uri.file((0,a.join)(r,"javaScript@2x.png"))},{label:"JavaScript Modifier",type:"javaScriptModifier",iconPath:o.Uri.file((0,a.join)(r,"javaScriptModifier@2x.png"))},{label:"JavaScript Deformer",type:"javaScriptDeformer",iconPath:o.Uri.file((0,a.join)(r,"javaScriptDeformer@2x.png"))},{label:"JavaScript Emitter",type:"javaScriptEmitter",iconPath:o.Uri.file((0,a.join)(r,"javaScriptEmitter@2x.png"))},{label:"SkSL Shader",type:"skslShader",iconPath:o.Uri.file((0,a.join)(r,"skslShader@2x.png"))},{label:"SkSL Filter",type:"skslFilter",iconPath:o.Uri.file((0,a.join)(r,"skslFilter@2x.png"))},{label:"Renders",kind:o.QuickPickItemKind.Separator},{label:"Setup Script",type:"renderSetupExpression",iconPath:o.Uri.file((0,a.join)(r,"dynamicRendering@2x.png"))},{label:"Pre-Render Script",type:"preRenderExpression",iconPath:o.Uri.file((0,a.join)(r,"dynamicRendering@2x.png"))},{label:"Post-Render Script",type:"postRenderExpression",iconPath:o.Uri.file((0,a.join)(r,"dynamicRendering@2x.png"))}]);if(!i)return;let n=i.type.toLowerCase();e.languageId!=="javascript"&&e.languageId!=="typescript"&&(n.startsWith("javascript")||n.includes("render"))&&o.window.showWarningMessage("Language is not JavaScript or TypeScript");let s=/\/\/\/\s<reference.+\/>(\r?\n|$)/g,c=e.getText().replace(s,"").trim(),l=e.languageId==="typescript"?E(c):c;await y({type:i.type,code:l})}catch(e){console.error(e),o.window.showErrorMessage(e.message)}};var j=require("fs"),h=require("fs/promises"),v=require("os"),g=require("path"),L=require("vscode");var V=async()=>{try{let t="Stallion.js",e=(0,g.join)(__dirname,t);console.log({source:e});let r=(0,v.platform)()==="darwin",i=(0,v.homedir)(),n=r?(0,g.join)(i,"Library","Application Support"):(0,g.join)(i,"AppData","Roaming"),s=(0,g.join)(n,"Cavalry","Scripts"),c=(0,g.join)(s,t);if((0,j.existsSync)(s)||await(0,h.mkdir)(s),(0,j.existsSync)(c)){let l=await I(c),d=R;if(l.match(/VERSION \d+.\d+.\d+/)?.[0].replace("VERSION ","")===d)return}await(0,h.copyFile)(e,c)}catch(t){L.window.showErrorMessage(t.message)}};async function K(t){console.log("Stallion activated"),await V();let e=S.commands.registerCommand("stallion.post",N),r=S.commands.registerCommand("stallion.postas",()=>J(t)),i=S.commands.registerCommand("stallion.insert",F);t.subscriptions.push(e,i,r)}function q(){}0&&(module.exports={activate,deactivate});
